import aiohttp
import datetime
from telegram import Update
from telegram.ext import ApplicationBuilder, CommandHandler, ContextTypes

BOT_TOKEN = "8628474974:AAH3995lgTDmZeLaFKzfBU_sxKySIzWH10w"
API_KEY = "DANGERxINFO"
API_URL = "https://danger-info-alpha.vercel.app/accinfo"


# ğŸ•’ Time Convert
def format_time(ts):
    try:
        return datetime.datetime.fromtimestamp(int(ts)).strftime("%d %b %Y, %I:%M %p")
    except:
        return "Unknown"


# â„¹ï¸ INFO COMMAND
async def info_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not context.args:
        await update.message.reply_text("Use like this:\n/info uid\nExample: /info 2133907304")
        return

    uid = context.args[0]
    msg = await update.message.reply_text("Fetching player info... â³")

    url = f"{API_URL}?uid={uid}&key={API_KEY}"

    try:
        async with aiohttp.ClientSession() as session:
            async with session.get(url, timeout=15) as resp:

                if resp.status != 200:
                    await msg.edit_text(f"API Error âŒ\nStatus Code: {resp.status}")
                    return

                data = await resp.json()

    except Exception as e:
        await msg.edit_text(f"Request Failed âŒ\n{str(e)}")
        return

    if "basicInfo" not in data:
        await msg.edit_text("Player not found âŒ")
        return

    b = data["basicInfo"]
    s = data.get("socialInfo", {})
    c = data.get("clanBasicInfo", {})
    p = data.get("petInfo", {})

    text = f"""
â•”â•â•ã€ ğŸ® PLAYER PROFILE ã€â•â•â•—

ğŸ‘¤ Nickname: {b.get('nickname')}
ğŸ†” UID: {b.get('accountId')}
ğŸŒ Region: {b.get('region')}
ğŸ– Level: {b.get('level')}
â¤ï¸ Likes: {b.get('liked')}

ğŸ† BR Rank: {b.get('rank')} ({b.get('rankingPoints')} pts)
ğŸ¯ CS Rank: {b.get('csRank')} ({b.get('csRankingPoints')} pts)
ğŸ”¥ Max Rank: {b.get('maxRank')}

ğŸ“… Created: {format_time(b.get('createAt'))}
â° Last Login: {format_time(b.get('lastLoginAt'))}

â• â•â• ğŸ¾ PET INFO â•â•â•£
ğŸ¶ Pet: {p.get('name', 'No Pet')} (Lv {p.get('level', '-')})

â• â•â• ğŸ° CLAN INFO â•â•â•£
ğŸ· Clan: {c.get('clanName', 'No Clan')}
ğŸ‘¥ Members: {c.get('memberNum', '-')}/{c.get('capacity', '-')}

â• â•â• ğŸŒ SOCIAL â•â•â•£
ğŸ—£ Language: {s.get('language')}
ğŸ“ Signature: {s.get('signature', 'No signature')}

â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""

    await msg.edit_text(text)


# â–¶ï¸ BOT START
if __name__ == "__main__":
    app = ApplicationBuilder().token(BOT_TOKEN).build()
    app.add_handler(CommandHandler("info", info_command))

    print("Bot running...")
    app.run_polling()